<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dependency Exposer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="w-full max-w-2xl">
        <!-- Title -->
        <h1 class="text-4xl font-bold text-gray-800 text-center mb-8">Dependency Exposer</h1>

        <!-- Input Form -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <div class="space-y-6">
                <!-- Package Name Input -->
                <div>
                    <label for="packageName" class="block text-sm font-medium text-gray-700 mb-2">Package Name</label>
                    <input
                        type="text"
                        id="packageName"
                        placeholder="Enter package name (e.g., express, Newtonsoft.Json, requests)"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                    >
                </div>
                <div id="autocompleteSuggestions" class="mt-2 bg-white border border-gray-300 rounded-lg shadow-lg hidden absolute z-50 w-full max-w-2xl"></div>

                <!-- Ecosystem Dropdown -->
                <div>
                    <label for="ecosystem" class="block text-sm font-medium text-gray-700 mb-2">Package Ecosystem</label>
                    <select
                        id="ecosystem"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg bg-white"
                    >
                        <option value="npm">NPM</option>
                        <option value="nuget">NuGet</option>
                        <option value="pypi">PyPI</option>
                    </select>
                </div>
                <!-- Analyze Button -->
                <button
                    id="analyzeBtn"
                    onclick="analyzeDependencies()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 text-lg"
                >
                    Analyze Dependencies
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden text-center py-8">
            <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-blue-600 bg-white">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Analyzing dependencies...
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Dependencies</h2>
            <div id="dependencyList" class="space-y-2"></div>
            <div id="stats" class="mt-6 p-4 bg-gray-50 rounded-lg text-sm text-gray-600"></div>
        </div>

        <!-- Error Display -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Error</h3>
                    <div id="errorMessage" class="mt-2 text-sm text-red-700"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allDependencies = new Set();
        let processedPackages = new Set();
        let circularDeps = new Set();

        async function analyzeDependencies() {
            const packageName = document.getElementById('packageName').value.trim();
            const ecosystem = document.getElementById('ecosystem').value;

            if (!packageName) {
                showError('Please enter a package name');
                return;
            }

            // Reset state
            allDependencies.clear();
            processedPackages.clear();
            circularDeps.clear();

            showLoading();
            hideError();
            hideResults();

            try {
                await findDependencies(packageName, ecosystem, 0);
                displayResults(packageName, ecosystem);
            } catch (error) {
                showError(`Failed to analyze dependencies: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function findDependencies(packageName, ecosystem, depth = 0) {
            const packageKey = `${ecosystem}:${packageName}`;
            if (processedPackages.has(packageKey)) {
                circularDeps.add(packageName);
                return;
            }

            processedPackages.add(packageKey);

            try {
                let dependencies = [];

                if (ecosystem === 'npm') {
                    dependencies = await getNpmDependencies(packageName);
                } else if (ecosystem === 'nuget') {
                    dependencies = await getNuGetDependencies(packageName);
                } else if (ecosystem === 'pypi') {
                    dependencies = await getPyPIDependencies(packageName);
                }

                dependencies.forEach(dep => allDependencies.add(dep));

                await Promise.all(
                    dependencies.map(dep => findDependencies(dep, ecosystem, depth + 1))
                );

            } catch (error) {
                console.warn(`Failed to get dependencies for ${packageName}:`, error);
            }
        }

        async function getNpmDependencies(packageName) {
            const response = await fetch(`https://registry.npmjs.org/${encodeURIComponent(packageName)}`);

            if (!response.ok) {
                throw new Error(`Package "${packageName}" not found in NPM registry`);
            }

            const data = await response.json();
            const latestVersion = data['dist-tags']?.latest;

            if (!latestVersion || !data.versions?.[latestVersion]) {
                return [];
            }

            const dependencies = data.versions[latestVersion].dependencies || {};
            return Object.keys(dependencies);
        }

        async function getNuGetDependencies(packageName) {
            // Using NuGet's API v3
            const searchResponse = await fetch(`https://api.nuget.org/v3-flatcontainer/${encodeURIComponent(packageName.toLowerCase())}/index.json`);

            if (!searchResponse.ok) {
                throw new Error(`Package "${packageName}" not found in NuGet registry`);
            }

            const versionData = await searchResponse.json();
            const latestVersion = versionData.versions[versionData.versions.length - 1];

            // Get package details for the latest version
            const packageResponse = await fetch(`https://api.nuget.org/v3-flatcontainer/${encodeURIComponent(packageName.toLowerCase())}/${latestVersion}/${packageName.toLowerCase()}.nuspec`);

            if (!packageResponse.ok) {
                return [];
            }

            const nuspecText = await packageResponse.text();

            // Parse XML to extract dependencies (basic parsing)
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(nuspecText, 'text/xml');
            const dependencyElements = xmlDoc.querySelectorAll('dependency');

            const dependencies = [];
            dependencyElements.forEach(dep => {
                const id = dep.getAttribute('id');
                if (id) {
                    dependencies.push(id);
                }
            });

            return dependencies;
        }

        async function getPyPIDependencies(packageName) {
            try {
                // Use PyPI's JSON API
                const response = await fetch(`https://pypi.org/pypi/${encodeURIComponent(packageName)}/json`);

                if (!response.ok) {
                    throw new Error(`Package "${packageName}" not found in PyPI registry`);
                }

                const data = await response.json();
                const info = data.info;

                if (!info) {
                    return [];
                }

                const dependencies = new Set();

                // Extract dependencies from requires_dist
                if (info.requires_dist && Array.isArray(info.requires_dist)) {
                    info.requires_dist.forEach(req => {
                        // Parse requirement string to extract package name
                        // Format is typically: "package-name (>=version)" or "package-name; extra == 'optional'"
                        const match = req.match(/^([a-zA-Z0-9\-_.]+)/);
                        if (match) {
                            const depName = match[1];
                            // Skip common development/test dependencies that aren't core runtime deps
                            if (!isDevDependency(depName, req)) {
                                dependencies.add(depName);
                            }
                        }
                    });
                }

                return Array.from(dependencies);
            } catch (error) {
                console.warn(`Failed to get PyPI dependencies for ${packageName}:`, error);
                return [];
            }
        }

        function isDevDependency(packageName, requirementString) {
            // Skip dependencies that are clearly dev/test only
            const devKeywords = ['test', 'dev', 'lint', 'format', 'coverage', 'mock', 'pytest', 'tox'];
            const lowerName = packageName.toLowerCase();
            const lowerReq = requirementString.toLowerCase();

            // Check if it's an extra dependency (optional)
            if (lowerReq.includes('extra ==')) {
                return true;
            }

            // Check if package name suggests it's a dev dependency
            return devKeywords.some(keyword => lowerName.includes(keyword));
        }

        function displayResults(rootPackage, ecosystem) {
            const resultsDiv = document.getElementById('results');
            const dependencyList = document.getElementById('dependencyList');
            const stats = document.getElementById('stats');

            // Convert Set to sorted array
            const sortedDependencies = Array.from(allDependencies).sort();

            // Clear previous results
            dependencyList.innerHTML = '';

            if (sortedDependencies.length === 0) {
                dependencyList.innerHTML = '<p class="text-gray-500 italic">No dependencies found or package does not exist.</p>';
            } else {
                sortedDependencies.forEach(dep => {
                    const depElement = document.createElement('div');
                    depElement.className = 'flex items-center py-2 px-3 bg-gray-50 rounded border-l-4 border-blue-400';

                    const isCircular = circularDeps.has(dep);
                    if (isCircular) {
                        depElement.className += ' border-yellow-400 bg-yellow-50';
                    }

                    depElement.innerHTML = `
                        <span class="font-mono text-sm ${isCircular ? 'text-yellow-800' : 'text-gray-800'}">${dep}</span>
                        ${isCircular ? '<span class="ml-2 text-xs text-yellow-600 font-semibold">(Circular)</span>' : ''}
                    `;
                    dependencyList.appendChild(depElement);
                });
            }

            // Display statistics
            const ecosystemColors = {
                'npm': 'text-red-600',
                'nuget': 'text-blue-600',
                'pypi': 'text-green-600'
            };

            stats.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <span class="block text-2xl font-bold text-blue-600">${sortedDependencies.length}</span>
                        <span class="text-xs uppercase tracking-wide">Total Dependencies</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-2xl font-bold ${ecosystemColors[ecosystem] || 'text-purple-600'}">${ecosystem.toUpperCase()}</span>
                        <span class="text-xs uppercase tracking-wide">Ecosystem</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-2xl font-bold text-yellow-600">${circularDeps.size}</span>
                        <span class="text-xs uppercase tracking-wide">Circular Refs</span>
                    </div>
                </div>
            `;

            resultsDiv.classList.remove('hidden');
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('results').classList.add('hidden');
        }

        // Allow Enter key to trigger analysis
        document.getElementById('packageName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeDependencies();
            }
        });

        const packageInput = document.getElementById('packageName');
    const ecosystemSelect = document.getElementById('ecosystem');
    const suggestionBox = document.getElementById('autocompleteSuggestions');

    let debounceTimeout;

    packageInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        const query = packageInput.value.trim();

        if (query.length < 3) {
            hideSuggestions();
            return;
        }

        debounceTimeout = setTimeout(() => {
            const ecosystem = ecosystemSelect.value;
            fetchSuggestions(query, ecosystem);
        }, 300); // Debounce for performance
    });

    document.addEventListener('click', (e) => {
        if (!suggestionBox.contains(e.target) && e.target !== packageInput) {
            hideSuggestions();
        }
    });

    async function fetchSuggestions(query, ecosystem) {
        try {
            let suggestions = [];

            if (ecosystem === 'npm') {
                const res = await fetch(`https://registry.npmjs.org/-/v1/search?text=${encodeURIComponent(query)}&size=10`);
                const data = await res.json();
                suggestions = data.objects.map(obj => obj.package.name);
            } else if (ecosystem === 'nuget') {
                const res = await fetch(`https://api-v2v3search-0.nuget.org/autocomplete?q=${encodeURIComponent(query)}&take=10`);
                const data = await res.json();
                suggestions = data.data;
            } else if (ecosystem === 'pypi') {
                const res = await fetch(`https://pypi.org/search/?q=${encodeURIComponent(query)}`);
                const text = await res.text();
                const matches = [...text.matchAll(/<a[^>]*href="\/project\/([^/]+)\/"/g)];
                suggestions = [...new Set(matches.map(m => m[1]))].slice(0, 10);
            }

            showSuggestions(suggestions);
        } catch (error) {
            console.warn('Autocomplete error:', error);
            hideSuggestions();
        }
    }

    function showSuggestions(suggestions) {
        if (suggestions.length === 0) {
            hideSuggestions();
            return;
        }

        suggestionBox.innerHTML = suggestions.map(pkg =>
            `<div class="px-4 py-2 hover:bg-blue-100 cursor-pointer text-sm" onclick="selectSuggestion('${pkg}')">${pkg}</div>`
        ).join('');
        suggestionBox.classList.remove('hidden');
    }

    function hideSuggestions() {
        suggestionBox.classList.add('hidden');
        suggestionBox.innerHTML = '';
    }

    function selectSuggestion(pkgName) {
        packageInput.value = pkgName;
        hideSuggestions();
    }
    </script>
</body>
</html>
